"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[465],{8465:function(e,t,o){o.r(t),o.d(t,{default:function(){return eI}});var r=o(7437),a=o(2265),n=o(6785),s=o(197),l=o(3775);o(715);var i=o(1326),d=o(511),c=o(888),u=o(335),g=o(8507),h=o(468),p=o(5253),x=o(5693),m=o(7622),b=o(8125),f=o(6424),y=o(2419),v=o(7630),C=o(5645),j=o(6798);let k={bg:{primary:"#1a1c1d",secondary:"#333738",tertiary:"#3a3d3e",hover:"#454849",input:"#1a1c1d",userMessage:"#2d3d4a"},border:{primary:"#777066",secondary:"#555048",subtle:"#3a3d3e"},text:{primary:"rgba(216, 215, 212, 0.87)",secondary:"#aaa59d",muted:"#999187",dim:"#777066",placeholder:"#777066"},accent:{blue:"#4a9eff",blueHover:"#3a8eef",orange:"#ff9800",orangeHover:"#ffb74d",green:"#81c784",userLabel:"#8ab4f8",error:"#f44336",delete:"#f44"},button:{primary:"#4a9eff",primaryHover:"#3a8eef",secondary:"#555048",secondaryHover:"#777066",danger:"#5c3a3a",dangerHover:"#7a4a4a",disabled:"#555048",disabledText:"#777066"}},Z={textField:{"& .MuiOutlinedInput-root":{backgroundColor:"transparent",color:k.text.primary,"& fieldset":{borderColor:k.border.secondary},"&:hover fieldset":{borderColor:k.border.primary},"&.Mui-focused fieldset":{borderColor:k.accent.blue}},"& .MuiInputBase-input::placeholder":{color:k.text.muted}},textFieldWithLabel:{"& .MuiOutlinedInput-root":{backgroundColor:"transparent",color:k.text.primary,"& fieldset":{borderColor:k.border.secondary},"&:hover fieldset":{borderColor:k.border.primary},"&.Mui-focused fieldset":{borderColor:k.accent.blue}},"& .MuiInputLabel-root":{color:k.text.muted},"& .MuiInputLabel-root.Mui-focused":{color:k.accent.blue}},select:{backgroundColor:"transparent",color:k.text.primary,"& .MuiOutlinedInput-notchedOutline":{borderColor:k.border.secondary},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:k.border.primary},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:k.accent.blue},"& .MuiSvgIcon-root":{color:k.text.muted}},panel:{backgroundColor:k.bg.secondary,border:"1px solid ".concat(k.border.primary),borderRadius:2},modal:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:k.bg.secondary,border:"1px solid ".concat(k.border.primary),borderRadius:2,p:3},buttonPrimary:{backgroundColor:"transparent",color:k.text.primary,"&:hover":{backgroundColor:"rgba(74, 158, 255, 0.1)"},"&.Mui-disabled":{backgroundColor:k.button.disabled,color:k.button.disabledText}},buttonSecondary:{py:1,backgroundColor:k.bg.tertiary,color:k.text.primary,textTransform:"none",fontWeight:500,border:"1px solid ".concat(k.border.secondary),"&:hover":{backgroundColor:k.bg.hover,borderColor:k.border.primary},"&.Mui-disabled":{backgroundColor:k.bg.secondary,color:k.border.secondary,borderColor:k.border.subtle}},iconButton:{backgroundColor:k.button.secondary,color:k.text.primary,width:24,height:24,"&:hover":{backgroundColor:k.button.secondaryHover}},iconButtonDanger:{backgroundColor:k.button.danger,color:k.text.primary,width:24,height:24,"&:hover":{backgroundColor:k.button.dangerHover}},divider:{borderColor:k.border.secondary},listItemButton:{borderRadius:1,py:.5,"&.Mui-selected":{backgroundColor:k.bg.tertiary,"&:hover":{backgroundColor:k.bg.hover}},"&:hover":{backgroundColor:k.bg.tertiary}},hoverBox:{"&:hover":{backgroundColor:k.bg.tertiary},borderRadius:1,cursor:"pointer"},iconButtonMuted:{color:k.text.muted,p:.5,"&:hover":{color:k.text.primary}},checkbox:{color:k.text.muted,"&.Mui-checked":{color:k.accent.blue}}},M={primary:{color:k.text.primary},secondary:{color:k.text.secondary},muted:{color:k.text.muted},dim:{color:k.text.dim},accent:{color:k.accent.blue},error:{color:k.accent.error}},S=e=>{let{text:t}=e,[o,n]=(0,a.useState)((null==t?void 0:t.length)>500),s=(null==t?void 0:t.length)>500,l=o?(null==t?void 0:t.slice(0,500))+"...":t;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(d.Z,{variant:"body2",sx:{color:k.text.primary,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:l}),s&&(0,r.jsx)(i.Z,{onClick:e=>{e.stopPropagation(),n(!o)},sx:{display:"flex",alignItems:"center",gap:.5,mt:.5,cursor:"pointer",color:k.accent.blue,"&:hover":{color:k.accent.blueHover}},children:o?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(b.Z,{sx:{fontSize:16}}),(0,r.jsxs)(d.Z,{variant:"caption",children:["Show more (",t.length," chars)"]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f.Z,{sx:{fontSize:16}}),(0,r.jsx)(d.Z,{variant:"caption",children:"Show less"})]})})]})};var w=(0,a.memo)(e=>{let{id:t,data:o,selected:s}=e,[l,b]=(0,a.useState)(!1),[f,M]=(0,a.useState)(!1),[w,I]=(0,a.useState)(""),L="loading"===o.status,N=o.isRoot,F=o.isMergeSource,z=o.isMergedNode,E=e=>{var r;e.stopPropagation(),null===(r=o.onEditNode)||void 0===r||r.call(o,t,w),M(!1)},A=e=>{e.stopPropagation(),M(!1)};return(0,r.jsxs)(i.Z,{onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),sx:{minWidth:350,maxWidth:500,backgroundColor:s?k.bg.tertiary:k.bg.secondary,border:F?"2px solid ".concat(k.accent.orange):s?"2px solid ".concat(k.accent.blue):"1px solid ".concat(k.border.primary),borderRadius:2,overflow:"hidden",cursor:"pointer",transition:"all 0.2s ease","&:hover":{borderColor:F?k.accent.orangeHover:k.text.muted}},children:[!N&&(0,r.jsx)(n.HH,{type:"target",position:n.Ly.Top,style:{background:k.accent.blue,width:8,height:8,border:"none"}}),(l||s)&&!N&&!L&&!f&&(0,r.jsxs)(i.Z,{sx:{position:"absolute",top:4,right:4,display:"flex",gap:.5,zIndex:10},children:[(0,r.jsx)(c.Z,{title:z?"Edit merge prompt":"Edit message",children:(0,r.jsx)(u.Z,{size:"small",onClick:e=>{e.stopPropagation(),I(o.userMessage||""),M(!0)},sx:Z.iconButton,children:(0,r.jsx)(x.Z,{sx:{fontSize:14}})})}),z&&(0,r.jsx)(c.Z,{title:"Regenerate merge (respects edge context settings)",children:(0,r.jsx)(u.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onRegenerateMerge)||void 0===r||r.call(o,t)},sx:{backgroundColor:k.accent.orange,color:k.text.primary,width:24,height:24,"&:hover":{backgroundColor:k.accent.orangeHover}},children:(0,r.jsx)(j.Z,{sx:{fontSize:14}})})}),(0,r.jsx)(c.Z,{title:"Merge branches here",children:(0,r.jsx)(u.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onMergeNode)||void 0===r||r.call(o,t)},sx:Z.iconButton,children:(0,r.jsx)(C.Z,{sx:{fontSize:14}})})}),(0,r.jsx)(c.Z,{title:"Delete node",children:(0,r.jsx)(u.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onDeleteNode)||void 0===r||r.call(o,t)},sx:Z.iconButtonDanger,children:(0,r.jsx)(m.Z,{sx:{fontSize:14}})})})]}),!N&&(0,r.jsxs)(i.Z,{sx:{p:1.5,backgroundColor:k.bg.userMessage,borderBottom:"1px solid ".concat(k.border.secondary)},children:[(0,r.jsx)(d.Z,{variant:"caption",sx:{color:k.accent.userLabel,fontWeight:500,mb:.5,display:"block"},children:"You"}),f?(0,r.jsxs)(i.Z,{sx:{display:"flex",flexDirection:"column",gap:1},children:[(0,r.jsx)(g.Z,{value:w,onChange:e=>I(e.target.value),multiline:!0,minRows:2,maxRows:6,size:"small",autoFocus:!0,onClick:e=>e.stopPropagation(),onKeyDown:e=>{"Enter"===e.key&&e.metaKey?E(e):"Escape"===e.key&&A(e)},sx:{...Z.textField,"& .MuiOutlinedInput-root":{...Z.textField["& .MuiOutlinedInput-root"],fontSize:"0.875rem"}}}),(0,r.jsxs)(i.Z,{sx:{display:"flex",gap:.5,justifyContent:"flex-end"},children:[(0,r.jsx)(u.Z,{size:"small",onClick:A,sx:Z.iconButton,children:(0,r.jsx)(v.Z,{sx:{fontSize:14}})}),(0,r.jsx)(u.Z,{size:"small",onClick:E,sx:{...Z.buttonPrimary,width:24,height:24},children:(0,r.jsx)(y.Z,{sx:{fontSize:14}})})]})]}):(0,r.jsx)(S,{text:o.userMessage})]}),(0,r.jsx)(i.Z,{sx:{p:1.5,minHeight:40},children:N?(0,r.jsx)(d.Z,{variant:"body2",sx:{color:k.text.muted,fontStyle:"italic"},children:"Start a conversation..."}):L?(0,r.jsxs)(i.Z,{display:"flex",alignItems:"center",gap:1,children:[(0,r.jsx)(h.Z,{size:16,sx:{color:k.accent.blue}}),(0,r.jsx)(d.Z,{variant:"body2",sx:{color:k.text.muted},children:"Generating..."})]}):o.assistantMessage?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(d.Z,{variant:"caption",sx:{color:k.accent.green,fontWeight:500,mb:.5,display:"block"},children:"Assistant"}),(0,r.jsx)(S,{text:o.assistantMessage})]}):o.error?(0,r.jsxs)(d.Z,{variant:"body2",sx:{color:k.accent.error},children:["Error: ",o.error]}):null}),(l||s)&&!L&&(0,r.jsx)(i.Z,{sx:{position:"absolute",bottom:-20,left:"50%",transform:"translateX(-50%)",zIndex:10},children:(0,r.jsx)(u.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onAddBranch)||void 0===r||r.call(o,t)},sx:{...Z.buttonPrimary,width:24,height:24},children:(0,r.jsx)(p.Z,{sx:{fontSize:16}})})}),(0,r.jsx)(n.HH,{type:"source",position:n.Ly.Bottom,style:{background:k.accent.blue,width:8,height:8,border:"none"}})]})});let I={FULL:"full",SINGLE:"single"};var L=(0,a.memo)(e=>{let{id:t,sourceX:o,sourceY:a,targetX:s,targetY:l,sourcePosition:d,targetPosition:u,style:g={},data:h,markerEnd:p}=e,[x,m,b]=(0,n.OQ)({sourceX:o,sourceY:a,sourcePosition:d,targetX:s,targetY:l,targetPosition:u}),f=(null==h?void 0:h.contextMode)||I.FULL,y=null==h?void 0:h.isMergeEdge,v=null==h?void 0:h.onToggleContextMode;return y?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("path",{id:t,style:g,className:"react-flow__edge-path",d:x,markerEnd:p}),(0,r.jsx)(n.XQ,{children:(0,r.jsx)(c.Z,{title:f===I.FULL?"Full branch context - Click to use single message only":"Single message only - Click to use full branch context",arrow:!0,children:(0,r.jsx)(i.Z,{onClick:e=>{e.stopPropagation(),null==v||v(t)},sx:{position:"absolute",transform:"translate(-50%, -50%) translate(".concat(m,"px,").concat(b,"px)"),pointerEvents:"all",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",width:24,height:24,borderRadius:"50%",backgroundColor:f===I.FULL?k.accent.orange:k.border.primary,border:"2px solid ".concat(k.bg.primary),color:k.text.primary,fontSize:10,fontWeight:"bold",transition:"all 0.2s ease","&:hover":{transform:"translate(-50%, -50%) translate(".concat(m,"px,").concat(b,"px) scale(1.2)"),backgroundColor:f===I.FULL?k.accent.orangeHover:k.text.muted}},children:f===I.FULL?"∞":"1"})})})]}):(0,r.jsx)("path",{id:t,style:g,className:"react-flow__edge-path",d:x,markerEnd:p})}),N=o(2118),F=o(4990),z=o(2844),E=o(5786),A=o(6548),R=o(3628);let U="bushchat-chats",B="bushchat-active-chat",W="bushchat-settings",H="bushchat-api-key",D=["chatgpt-4o-latest","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo","o1-preview","o1-mini"],P=[{id:"root",type:"chatNode",position:{x:400,y:50},data:{isRoot:!0,userMessage:"",assistantMessage:"",status:"complete"}}],K=[];var O=e=>{let{open:t,onClose:o,settings:n,onSave:s,modelsList:l,setModelsList:c,setSelectedModel:h}=e,[p,x]=(0,a.useState)({...n}),[m,b]=(0,a.useState)(!1);a.useEffect(()=>{t&&x({...n})},[t,n]);let f=(0,a.useCallback)(async()=>{b(!0);try{var e,t,o;let r=p.apiUrl||"https://api.openai.com/v1",a=await fetch("".concat(r,"/models"),{headers:p.apiKey?{Authorization:"Bearer ".concat(p.apiKey)}:{}});if(!a.ok)throw Error("Failed to fetch models");let n=await a.json(),s=(null===(o=n.data)||void 0===o?void 0:null===(t=o.map(e=>e.id))||void 0===t?void 0:null===(e=t.filter(e=>e&&!e.includes("embedding")&&!e.includes("whisper")&&!e.includes("tts")&&!e.includes("dall-e")))||void 0===e?void 0:e.sort())||[];s.length>0&&(c(s),h(e=>s.includes(e)?e:s[0]))}catch(e){console.error("Failed to fetch models:",e)}finally{b(!1)}},[p,c,h]);return(0,r.jsx)(N.Z,{open:t,onClose:o,children:(0,r.jsxs)(F.Z,{sx:{...Z.modal,minWidth:400,maxWidth:500},children:[(0,r.jsx)(d.Z,{variant:"h6",sx:{color:k.text.primary,mb:2},children:"Settings"}),(0,r.jsxs)(i.Z,{sx:{display:"flex",flexDirection:"column",gap:2},children:[(0,r.jsx)(g.Z,{label:"API Key",type:"password",value:p.apiKey,onChange:e=>x({...p,apiKey:e.target.value}),placeholder:"sk-... (leave empty to use server .env)",fullWidth:!0,size:"small",autoComplete:"off",autoCorrect:"off",spellCheck:!1,sx:Z.textFieldWithLabel}),(0,r.jsx)(z.Z,{control:(0,r.jsx)(E.Z,{checked:p.saveApiKey,onChange:e=>x({...p,saveApiKey:e.target.checked}),sx:Z.checkbox}),label:(0,r.jsx)(d.Z,{variant:"body2",sx:M.secondary,children:"\uD83D\uDE48 Save API key in browser storage"})}),(0,r.jsxs)(i.Z,{sx:{display:"flex",gap:1,alignItems:"flex-start"},children:[(0,r.jsx)(g.Z,{label:"OpenAI Compatible URL",value:p.apiUrl,onChange:e=>x({...p,apiUrl:e.target.value}),placeholder:"https://api.openai.com/v1 (leave empty for default)",fullWidth:!0,size:"small",autoComplete:"off",autoCorrect:"off",spellCheck:!1,sx:Z.textFieldWithLabel}),(0,r.jsx)(u.Z,{onClick:f,disabled:m,sx:{mt:.5,color:k.accent.blue,"&:hover":{backgroundColor:"rgba(74, 158, 255, 0.1)"},"&.Mui-disabled":{color:k.text.dim},animation:m?"spin 1s linear infinite":"none","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}},title:"Fetch models from API",children:(0,r.jsx)(R.Z,{})})]}),l.length>0&&l!==D&&(0,r.jsxs)(d.Z,{variant:"caption",sx:M.accent,children:["✓ Loaded ",l.length," models from provider"]}),(0,r.jsx)(d.Z,{variant:"caption",sx:M.dim,children:"These settings override the server .env configuration. Leave empty to use server defaults."}),(0,r.jsxs)(i.Z,{sx:{display:"flex",gap:1,justifyContent:"flex-end",mt:1},children:[(0,r.jsx)(A.Z,{onClick:o,sx:M.muted,children:"Cancel"}),(0,r.jsx)(A.Z,{onClick:()=>{s(p),o()},variant:"contained",sx:Z.buttonPrimary,children:"Save"})]})]})]})})},T=o(1234);let _=(e,t,o)=>{let r=[],a=e;for(;a;){let e=t.find(e=>e.id===a);e&&r.unshift(e);let n=o.find(e=>e.target===a);a=n?n.source:null}return r},J=e=>{let t=[];for(let o of e)!o.data.isRoot&&(o.data.userMessage&&t.push({role:"user",content:o.data.userMessage}),o.data.assistantMessage&&t.push({role:"assistant",content:o.data.assistantMessage}));return t},G=(e,t,o,r)=>{let a=_(e,o,r),n=_(t,o,r),s=new Set(a.map(e=>e.id));for(let e=n.length-1;e>=0;e--)if(s.has(n[e].id))return n[e].id;return"root"},Y=(e,t,o)=>{let r=[],a=[e];for(;a.length>0;){let e=a.shift();for(let t of o.filter(t=>t.source===e))r.push(t.target),a.push(t.target)}return r},V=e=>{var t;let o=e.find(e=>{var t,o;return!(null===(t=e.data)||void 0===t?void 0:t.isRoot)&&(null===(o=e.data)||void 0===o?void 0:o.userMessage)});if(null==o?void 0:null===(t=o.data)||void 0===t?void 0:t.userMessage){let e=o.data.userMessage;return e.length>30?e.substring(0,30)+"...":e}return"New Chat"},Q=()=>"chat-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),X=()=>{try{let e=localStorage.getItem(U);if(e)return JSON.parse(e)}catch(e){console.error("Failed to load chats list:",e)}return[]},q=e=>{try{localStorage.setItem(U,JSON.stringify(e))}catch(e){console.error("Failed to save chats list:",e)}},$=e=>{try{let t=localStorage.getItem("bushchat-".concat(e));if(t)return JSON.parse(t)}catch(e){console.error("Failed to load chat state:",e)}return null},ee=(e,t,o,r,a)=>{try{let n=t.map(e=>({...e,data:{...e.data,onAddBranch:void 0,onEditNode:void 0,onDeleteNode:void 0,onMergeNode:void 0,onRegenerateMerge:void 0,isMergeSource:void 0}}));localStorage.setItem("bushchat-".concat(e),JSON.stringify({nodes:n,edges:o,selectedNodeId:r,nodeIdCounter:a}));let s=X(),l=s.findIndex(t=>t.id===e);l>=0&&(s[l].name=V(n),s[l].updatedAt=Date.now(),q(s))}catch(e){console.error("Failed to save chat state:",e)}},et=e=>{localStorage.removeItem("bushchat-".concat(e))},eo=()=>{try{let e=localStorage.getItem(B);if(!e){e=Q(),localStorage.setItem(B,e);let t=[{id:e,name:"New Chat",createdAt:Date.now(),updatedAt:Date.now()}];q(t)}return e}catch(e){console.error("Failed to get active chat:",e)}return Q()},er=e=>{localStorage.setItem(B,e)},ea=()=>{try{let e=localStorage.getItem(W),t=localStorage.getItem(H),o=e?JSON.parse(e):{apiUrl:"",saveApiKey:!1};return t&&o.saveApiKey?o.apiKey=t:o.apiKey="",o}catch(e){console.error("Failed to load settings:",e)}return{apiKey:"",apiUrl:"",saveApiKey:!1}},en=(e,t)=>{try{let o={apiUrl:e.apiUrl,saveApiKey:t};localStorage.setItem(W,JSON.stringify(o)),t&&e.apiKey?localStorage.setItem(H,e.apiKey):localStorage.removeItem(H)}catch(e){console.error("Failed to save settings:",e)}},es=()=>localStorage.getItem("bushchat-waitlist-email"),el=e=>{localStorage.setItem("bushchat-waitlist-email",e)};var ei=e=>{let{open:t,onClose:o}=e,[n,s]=(0,a.useState)(""),[l,c]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{let e=es();e&&(s(e),c(!0))},[]),(0,r.jsx)(N.Z,{open:t,onClose:o,children:(0,r.jsx)(F.Z,{sx:{...Z.modal,minWidth:360,maxWidth:420},children:(0,r.jsxs)(i.Z,{sx:{textAlign:"center"},children:[(0,r.jsx)(i.Z,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"12px",backgroundColor:k.bg.tertiary,border:"1px solid ".concat(k.border.secondary),mb:2},children:(0,r.jsx)(T.Z,{sx:{color:k.text.muted,fontSize:24}})}),(0,r.jsx)(d.Z,{variant:"h6",sx:{background:"linear-gradient(135deg, ".concat(k.accent.blue," 0%, #82c4ff 100%)"),backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",mb:1,fontWeight:600},children:"Cloud Sync"}),(0,r.jsx)(d.Z,{variant:"body2",sx:{...M.muted,mb:3,lineHeight:1.6},children:"Sync your conversations across devices, share branches with collaborators, and never lose your chat history."}),l?(0,r.jsxs)(i.Z,{sx:{p:2,borderRadius:1.5,backgroundColor:"rgba(74, 158, 255, 0.08)",border:"1px solid rgba(74, 158, 255, 0.2)"},children:[(0,r.jsx)(d.Z,{variant:"body2",sx:M.accent,children:"✓ You're on the list!"}),(0,r.jsx)(d.Z,{variant:"caption",sx:{...M.dim,display:"block",mt:.5},children:"We'll notify you when cloud sync is ready."})]}):(0,r.jsxs)(i.Z,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[(0,r.jsx)(g.Z,{placeholder:"Enter your email",value:n,onChange:e=>s(e.target.value),fullWidth:!0,size:"small",autoComplete:"email",type:"email",sx:Z.textField}),(0,r.jsx)(A.Z,{onClick:()=>{console.log("Waitlist signup:",n),el(n),c(!0)},disabled:!n.trim()||!n.includes("@"),fullWidth:!0,sx:Z.buttonSecondary,children:"Join Waitlist"})]}),(0,r.jsx)(d.Z,{variant:"caption",sx:{...M.dim,display:"block",mt:2},children:"Coming Soon"})]})})})},ed=o(7318),ec=o(9216),eu=o(2184),eg=o(1807),eh=o(7300),ep=o(7905),ex=o(7883),em=o(1287),eb=e=>{let{chatsList:t,activeChatId:o,onCreateNewChat:n,onSwitchChat:s,onDeleteChat:l,onOpenSettings:c,onOpenWaitlist:g,mergeMode:h,onCancelMerge:x,conversationHistoryLength:m}=e,[y,v]=(0,a.useState)(!1);return(0,r.jsxs)(F.Z,{sx:{...Z.panel,border:h?"1px solid ".concat(k.accent.orange):"1px solid ".concat(k.border.primary),minWidth:220,maxWidth:280,overflow:"hidden"},children:[(0,r.jsxs)(i.Z,{sx:{p:1.5,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,r.jsx)(d.Z,{variant:"subtitle2",sx:{color:k.accent.blue},children:"bushchat"}),(0,r.jsxs)(i.Z,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(0,r.jsx)(u.Z,{size:"small",onClick:g,sx:Z.iconButtonMuted,title:"Sync to Cloud (Coming Soon)",children:(0,r.jsx)(T.Z,{fontSize:"small"})}),(0,r.jsx)(u.Z,{size:"small",onClick:c,sx:Z.iconButtonMuted,children:(0,r.jsx)(em.Z,{fontSize:"small"})})]})]}),(0,r.jsx)(ed.Z,{sx:Z.divider}),(0,r.jsxs)(i.Z,{sx:{p:1},children:[(0,r.jsxs)(i.Z,{onClick:()=>v(!y),sx:{...Z.hoverBox,display:"flex",alignItems:"center",justifyContent:"space-between",py:.5,px:.5,mx:-.5},children:[(0,r.jsx)(d.Z,{variant:"caption",sx:M.muted,children:"Chats"}),(0,r.jsxs)(i.Z,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(0,r.jsx)(u.Z,{size:"small",onClick:e=>{e.stopPropagation(),n()},sx:{color:k.accent.blue,p:.25},children:(0,r.jsx)(p.Z,{sx:{fontSize:16}})}),y?(0,r.jsx)(f.Z,{sx:{fontSize:16,color:k.text.muted}}):(0,r.jsx)(b.Z,{sx:{fontSize:16,color:k.text.muted}})]})]}),(0,r.jsx)(ec.Z,{in:y,children:(0,r.jsx)(eu.Z,{dense:!0,sx:{py:.5,maxHeight:200,overflow:"auto"},children:t.map(e=>(0,r.jsx)(eg.ZP,{disablePadding:!0,secondaryAction:t.length>1&&(0,r.jsx)(u.Z,{edge:"end",size:"small",onClick:t=>l(e.id,t),sx:{color:k.text.dim,"&:hover":{color:k.accent.delete},p:.5},children:(0,r.jsx)(ex.Z,{fontSize:"small"})}),children:(0,r.jsx)(eh.Z,{selected:e.id===o,onClick:()=>s(e.id),sx:Z.listItemButton,children:(0,r.jsx)(ep.Z,{primary:e.name,primaryTypographyProps:{variant:"caption",sx:{color:e.id===o?k.text.primary:k.text.secondary,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}})})},e.id))})})]}),(0,r.jsx)(ed.Z,{sx:Z.divider}),(0,r.jsxs)(i.Z,{sx:{p:1.5},children:[h?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(d.Z,{variant:"caption",sx:{color:k.accent.orange,display:"block",fontWeight:500},children:"\uD83D\uDD00 Merge Mode Active"}),(0,r.jsx)(d.Z,{variant:"caption",sx:{...M.muted,display:"block",mt:.5},children:"Click another node to merge, or click the same node to cancel"}),(0,r.jsx)(A.Z,{size:"small",onClick:x,sx:{mt:1,color:k.accent.orange,borderColor:k.accent.orange,"&:hover":{borderColor:k.accent.orangeHover,backgroundColor:"rgba(255,152,0,0.1)"}},variant:"outlined",children:"Cancel Merge"})]}):(0,r.jsx)(d.Z,{variant:"caption",sx:{...M.muted,display:"block"},children:"(+) branch • Edit/Delete on hover • Merge icon to combine"}),m>0&&(0,r.jsxs)(d.Z,{variant:"caption",sx:{...M.dim,display:"block",mt:.5},children:["Context: ",m," messages"]})]})]})},ef=o(8549),ey=o(9304),ev=o(6557),eC=o(559),ej=e=>{let{inputMessage:t,onInputChange:o,onSubmit:a,selectedModel:n,onModelChange:s,modelsList:l,isRootSelected:i}=e;return(0,r.jsxs)(F.Z,{component:"form",onSubmit:e=>{e.preventDefault(),t.trim()&&a(t.trim())},sx:{...Z.panel,display:"flex",alignItems:"center",gap:1,p:1.5,minWidth:600,mb:2},children:[(0,r.jsx)(g.Z,{id:"message-input",placeholder:i?"Start a new conversation...":"Continue or branch from selected node...",variant:"outlined",size:"small",value:t,onChange:e=>o(e.target.value),fullWidth:!0,autoComplete:"off",autoCorrect:"off",spellCheck:!1,sx:Z.textField}),(0,r.jsx)(ef.Z,{size:"small",sx:{minWidth:160},children:(0,r.jsx)(ey.Z,{value:n,onChange:e=>s(e.target.value),sx:Z.select,children:l.map(e=>(0,r.jsx)(ev.Z,{value:e,children:e},e))})}),(0,r.jsx)(u.Z,{type:"submit",disabled:!t.trim(),sx:Z.buttonPrimary,children:(0,r.jsx)(eC.Z,{})})]})};let ek=async(e,t,o,r)=>{try{let r=e.body.getReader(),a=new TextDecoder,n="";for(;;){let{done:e,value:o}=await r.read();if(e)break;for(let e of a.decode(o).split("\n").filter(e=>e.startsWith("data: "))){let o=e.slice(6);if("[DONE]"!==o)try{let e=JSON.parse(o);e.content&&(n+=e.content,t(n))}catch(e){}}}o(n)}catch(e){r(e)}},eZ=e=>({sendChatRequest:(0,a.useCallback)(async(t,o,r,a,n)=>{try{let s=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t,model:o,apiKey:e.apiKey||void 0,apiUrl:e.apiUrl||void 0})}),l=s.headers.get("content-type");if(null==l?void 0:l.includes("text/event-stream"))await ek(s,r,a,n);else{let e=await s.json();if(!s.ok)throw Error(e.error||"Failed to get response");a(e.response)}}catch(e){n(e)}},[e])}),eM={chatNode:w},eS={mergeEdge:L},ew=()=>{var e;let[t,o]=(0,a.useState)(()=>eo()),[d,c]=(0,a.useState)(()=>X()),[u,g]=(0,a.useState)(!1),[h,p]=(0,a.useState)(()=>ea()),[x,m]=(0,a.useState)(!1),b=(0,a.useMemo)(()=>$(t),[t]),[f,y,v]=(0,n.Rr)((null==b?void 0:b.nodes)||P),[C,j,Z]=(0,n.ll)((null==b?void 0:b.edges)||K),[M,S]=(0,a.useState)((null==b?void 0:b.selectedNodeId)||"root"),[w,L]=(0,a.useState)(""),[N,F]=(0,a.useState)(D[0]),[z,E]=(0,a.useState)(D),[A,R]=(0,a.useState)(null),U=(0,a.useRef)((null==b?void 0:b.nodeIdCounter)||1),{fitView:B}=(0,n._K)(),{sendChatRequest:W}=eZ(h);(0,a.useEffect)(()=>{let e=setTimeout(()=>{ee(t,f,C,M,U.current),c(X())},500);return()=>clearTimeout(e)},[f,C,M,t]);let H=(0,a.useCallback)(e=>{er(e),o(e);let t=$(e);t?(y(t.nodes||P),j(t.edges||K),S(t.selectedNodeId||"root"),U.current=t.nodeIdCounter||1):(y(P),j(K),S("root"),U.current=1),R(null),setTimeout(()=>B({padding:.2}),100)},[y,j,B]),T=(0,a.useCallback)(()=>{let e=Q(),t=[{id:e,name:"New Chat",createdAt:Date.now(),updatedAt:Date.now()},...d];q(t),c(t),H(e)},[d,H]),V=(0,a.useCallback)((e,o)=>{if(o.stopPropagation(),d.length<=1)return;let r=d.filter(t=>t.id!==e);q(r),c(r),et(e),e===t&&r.length>0&&H(r[0].id)},[d,t,H]),es=(0,a.useCallback)(e=>{p(e),en(e,e.saveApiKey)},[]),el=(0,a.useRef)(!1);(0,a.useEffect)(()=>{!el.current&&(h.apiKey||h.apiUrl)&&(el.current=!0,(async()=>{try{var e,t,o;let r=h.apiUrl||"https://api.openai.com/v1",a=await fetch("".concat(r,"/models"),{headers:h.apiKey?{Authorization:"Bearer ".concat(h.apiKey)}:{}});if(!a.ok)return;let n=await a.json(),s=(null===(o=n.data)||void 0===o?void 0:null===(t=o.map(e=>e.id))||void 0===t?void 0:null===(e=t.filter(e=>e&&!e.includes("embedding")&&!e.includes("whisper")&&!e.includes("tts")&&!e.includes("dall-e")))||void 0===e?void 0:e.sort())||[];s.length>0&&(E(s),F(e=>s.includes(e)?e:s[0]))}catch(e){console.error("Failed to fetch models:",e)}})())},[h.apiKey,h.apiUrl]);let ed=(0,a.useMemo)(()=>f.find(e=>e.id===M),[f,M]),ec=(0,a.useMemo)(()=>J(_(M,f,C)),[M,f,C]),eu=(0,a.useCallback)((e,t)=>{y(o=>o.map(o=>o.id===e?{...o,data:{...o.data,...t}}:o))},[y]),eg=(0,a.useCallback)(async(e,t)=>{let o="node-".concat(U.current++),r=f.find(t=>t.id===e),a=C.filter(t=>t.source===e),n=320*a.length,s={id:o,type:"chatNode",position:{x:r.position.x+n-(a.length>0?160:0),y:r.position.y+200},data:{userMessage:t,assistantMessage:"",status:"loading",isRoot:!1}};y(e=>[...e,s]),j(t=>[...t,{id:"edge-".concat(e,"-").concat(o),source:e,target:o,type:"smoothstep",style:{stroke:"#4a9eff",strokeWidth:2}}]),S(o);let l=J(_(e,f,C));l.push({role:"user",content:t}),await W(l,N,e=>{eu(o,{assistantMessage:e,status:"loading"})},e=>{eu(o,{assistantMessage:e,status:"complete"})},e=>{console.error(e),eu(o,{error:e.message,status:"error"})}),setTimeout(()=>B({padding:.2,duration:300}),100)},[f,C,N,y,j,eu,B,W]),eh=(0,a.useCallback)(e=>{var t;S(e),null===(t=document.getElementById("message-input"))||void 0===t||t.focus()},[]),ep=(0,a.useCallback)(async(e,t)=>{var o,r,a;if(!t.trim())return;let n=f.find(t=>t.id===e);if((null==n?void 0:null===(o=n.data)||void 0===o?void 0:o.isMergedNode)&&n.data.mergeParents){let o,s;let[l,i]=n.data.mergeParents,d=n.data.lcaId,c=C.find(t=>t.source===l&&t.target===e),u=C.find(t=>t.source===i&&t.target===e),g=(null==c?void 0:null===(r=c.data)||void 0===r?void 0:r.contextMode)||I.SINGLE,h=(null==u?void 0:null===(a=u.data)||void 0===a?void 0:a.contextMode)||I.SINGLE,p=_(l,f,C),x=_(i,f,C),m=p.findIndex(e=>e.id===d),b=x.findIndex(e=>e.id===d);if(g===I.FULL)o=p.slice(m+1);else{let e=p[p.length-1];o=e?[e]:[]}if(h===I.FULL)s=x.slice(b+1);else{let e=x[x.length-1];s=e?[e]:[]}let y=J(p.slice(0,m+1)),v=J(o),j=J(s),k=g===I.FULL?"full context":"single message",Z=h===I.FULL?"full context":"single message",M="You are continuing a conversation that has branched into two paths. Here are both branches:\n\n";for(let e of(M+="=== BRANCH A (".concat(k,") ===\n"),v))M+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");for(let e of(M+="=== BRANCH B (".concat(Z,") ===\n"),j))M+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");M+="=== END BRANCHES ===\n\n"+t,eu(e,{userMessage:t,assistantMessage:"",status:"loading",error:null});let S=[...y,{role:"user",content:M}];await W(S,N,t=>{eu(e,{assistantMessage:t,status:"loading"})},t=>{eu(e,{assistantMessage:t,status:"complete"})},t=>{console.error(t),eu(e,{error:t.message,status:"error"})});return}eu(e,{userMessage:t,assistantMessage:"",status:"loading",error:null});let s=C.find(t=>t.target===e),l=J(_((null==s?void 0:s.source)||"root",f,C));l.push({role:"user",content:t}),await W(l,N,t=>{eu(e,{assistantMessage:t,status:"loading"})},t=>{eu(e,{assistantMessage:t,status:"complete"})},t=>{console.error(t),eu(e,{error:t.message,status:"error"})})},[f,C,N,eu,W]),ex=(0,a.useCallback)(e=>{if("root"===e)return;let t=Y(e,f,C),o=new Set([e,...t]),r=C.find(t=>t.target===e),a=(null==r?void 0:r.source)||"root";y(e=>e.filter(e=>!o.has(e.id))),j(e=>e.filter(e=>!o.has(e.source)&&!o.has(e.target))),S(a)},[f,C,y,j]),em=(0,a.useCallback)(e=>{j(t=>t.map(t=>{if(t.id===e){var o;let e=((null===(o=t.data)||void 0===o?void 0:o.contextMode)||I.FULL)===I.FULL?I.SINGLE:I.FULL;return{...t,data:{...t.data,contextMode:e}}}return t}))},[j]),ef=(0,a.useCallback)(async e=>{var t,o,r;let a,n;let s=f.find(t=>t.id===e);if(!(null==s?void 0:null===(t=s.data)||void 0===t?void 0:t.isMergedNode)||!s.data.mergeParents)return;let[l,i]=s.data.mergeParents,d=s.data.lcaId,c=C.find(t=>t.source===l&&t.target===e),u=C.find(t=>t.source===i&&t.target===e),g=(null==c?void 0:null===(o=c.data)||void 0===o?void 0:o.contextMode)||I.FULL,h=(null==u?void 0:null===(r=u.data)||void 0===r?void 0:r.contextMode)||I.FULL,p=_(l,f,C),x=_(i,f,C),m=p.findIndex(e=>e.id===d),b=x.findIndex(e=>e.id===d);if(g===I.FULL)a=p.slice(m+1);else{let e=p[p.length-1];a=e?[e]:[]}if(h===I.FULL)n=x.slice(b+1);else{let e=x[x.length-1];n=e?[e]:[]}let y=J(p.slice(0,m+1)),v=J(a),j=J(n),k=g===I.FULL?"full context":"single message",Z=h===I.FULL?"full context":"single message",M="You are continuing a conversation that has branched into two paths. Here are both branches:\n\n";for(let e of(M+="=== BRANCH A (".concat(k,") ===\n"),v))M+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");for(let e of(M+="=== BRANCH B (".concat(Z,") ===\n"),j))M+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");M+="=== END BRANCHES ===\n\nPlease synthesize insights from both branches and continue the conversation, acknowledging key points from each path.",eu(e,{assistantMessage:"",status:"loading",error:null});let S=[...y,{role:"user",content:M}];await W(S,N,t=>{eu(e,{assistantMessage:t,status:"loading"})},t=>{eu(e,{assistantMessage:t,status:"complete"})},t=>{console.error(t),eu(e,{error:t.message,status:"error"})})},[f,C,N,eu,W]),ey=(0,a.useCallback)(async e=>{if("root"===e)return;if(!A){R({firstNodeId:e});return}if(A.firstNodeId===e){R(null);return}let t=A.firstNodeId,o=G(t,e,f,C),r=_(t,f,C),a=_(e,f,C),n=r.findIndex(e=>e.id===o),s=a.findIndex(e=>e.id===o),l=r.slice(n+1),i=a.slice(s+1),d=J(r.slice(0,n+1)),c=J(l),u=J(i),g="You are continuing a conversation that has branched into two paths. Here are both branches:\n\n";for(let e of(g+="=== BRANCH A ===\n",c))g+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");for(let e of(g+="=== BRANCH B ===\n",u))g+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");g+="=== END BRANCHES ===\n\nPlease synthesize insights from both branches and continue the conversation, acknowledging key points from each path.";let h="node-".concat(U.current++),p=f.find(e=>e.id===t),x=f.find(t=>t.id===e),m={id:h,type:"chatNode",position:{x:(p.position.x+x.position.x)/2,y:Math.max(p.position.y,x.position.y)+200},data:{userMessage:"[Merged from two branches]",assistantMessage:"",status:"loading",isRoot:!1,isMergedNode:!0,mergeParents:[t,e],lcaId:o}},b="edge-".concat(t,"-").concat(h),v="edge-".concat(e,"-").concat(h);y(e=>[...e,m]),j(o=>[...o,{id:b,source:t,target:h,type:"mergeEdge",style:{stroke:"#ff9800",strokeWidth:2},data:{isMergeEdge:!0,contextMode:I.SINGLE}},{id:v,source:e,target:h,type:"mergeEdge",style:{stroke:"#ff9800",strokeWidth:2},data:{isMergeEdge:!0,contextMode:I.SINGLE}}]),S(h),R(null);let k=[...d,{role:"user",content:g}];await W(k,N,e=>{eu(h,{assistantMessage:e,status:"loading"})},e=>{eu(h,{assistantMessage:e,status:"complete"})},e=>{console.error(e),eu(h,{error:e.message,status:"error"})}),setTimeout(()=>B({padding:.2,duration:300}),100)},[A,f,C,N,y,j,eu,B,W]),ev=(0,a.useMemo)(()=>f.map(e=>({...e,data:{...e.data,onAddBranch:eh,onEditNode:ep,onDeleteNode:ex,onMergeNode:ey,onRegenerateMerge:ef,isMergeSource:(null==A?void 0:A.firstNodeId)===e.id}})),[f,eh,ep,ex,ey,ef,A]),eC=(0,a.useMemo)(()=>C.map(e=>({...e,data:{...e.data,onToggleContextMode:em}})),[C,em]),ek=(0,a.useCallback)((e,t)=>{S(t.id)},[]);return(0,r.jsx)(i.Z,{sx:{width:"100vw",height:"100vh",backgroundColor:"#252627"},children:(0,r.jsxs)(n.x$,{nodes:ev,edges:eC,onNodesChange:v,onEdgesChange:Z,onNodeClick:ek,nodeTypes:eM,edgeTypes:eS,fitView:!0,minZoom:.1,maxZoom:2,defaultViewport:{x:0,y:0,zoom:.8},proOptions:{hideAttribution:!0},deleteKeyCode:null,selectionKeyCode:null,children:[(0,r.jsx)(s.A,{color:"#888888",gap:20}),(0,r.jsx)(l.Z,{style:{backgroundColor:k.bg.secondary,borderRadius:8,border:"1px solid ".concat(k.border.primary)}}),(0,r.jsx)(n.s_,{position:"bottom-center",children:(0,r.jsx)(ej,{inputMessage:w,onInputChange:L,onSubmit:e=>{eg(M,e),L("")},selectedModel:N,onModelChange:F,modelsList:z,isRootSelected:null==ed?void 0:null===(e=ed.data)||void 0===e?void 0:e.isRoot})}),(0,r.jsx)(n.s_,{position:"top-left",children:(0,r.jsx)(eb,{chatsList:d,activeChatId:t,onCreateNewChat:T,onSwitchChat:H,onDeleteChat:V,onOpenSettings:()=>g(!0),onOpenWaitlist:()=>m(!0),mergeMode:A,onCancelMerge:()=>R(null),conversationHistoryLength:ec.length})}),(0,r.jsx)(O,{open:u,onClose:()=>g(!1),settings:h,onSave:es,modelsList:z,setModelsList:E,setSelectedModel:F}),(0,r.jsx)(ei,{open:x,onClose:()=>m(!1)})]})})};var eI=()=>(0,r.jsx)(n.tV,{children:(0,r.jsx)(ew,{})})}}]);