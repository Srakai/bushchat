"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[891],{1891:function(e,t,o){o.r(t),o.d(t,{default:function(){return ey}});var r=o(7437),a=o(2265),s=o(6785),n=o(197),i=o(3775);o(715);var l=o(1326),d=o(4990),c=o(8507),u=o(8549),p=o(9304),g=o(6557),h=o(335),x=o(511),m=o(7318),f=o(9216),b=o(2184),y=o(1807),v=o(7300),C=o(7905),j=o(6548),k=o(2118),Z=o(2844),S=o(5786),M=o(559),w=o(8125),N=o(6424),I=o(5253),L=o(7883),E=o(1287),F=o(3628),U=o(1234),z=o(888),O=o(468),R=o(5693),A=o(7622),D=o(2419),W=o(7630),K=o(5645),B=o(6798);let P={bg:{primary:"#1a1c1d",secondary:"#333738",tertiary:"#3a3d3e",hover:"#454849",input:"#1a1c1d",userMessage:"#2d3d4a"},border:{primary:"#777066",secondary:"#555048",subtle:"#3a3d3e"},text:{primary:"rgba(216, 215, 212, 0.87)",secondary:"#aaa59d",muted:"#999187",dim:"#777066",placeholder:"#777066"},accent:{blue:"#4a9eff",blueHover:"#3a8eef",orange:"#ff9800",orangeHover:"#ffb74d",green:"#81c784",userLabel:"#8ab4f8",error:"#f44336",delete:"#f44"},button:{primary:"#4a9eff",primaryHover:"#3a8eef",secondary:"#555048",secondaryHover:"#777066",danger:"#5c3a3a",dangerHover:"#7a4a4a",disabled:"#555048",disabledText:"#777066"}},H={textField:{"& .MuiOutlinedInput-root":{backgroundColor:"transparent",color:P.text.primary,"& fieldset":{borderColor:P.border.secondary},"&:hover fieldset":{borderColor:P.border.primary},"&.Mui-focused fieldset":{borderColor:P.accent.blue}},"& .MuiInputBase-input::placeholder":{color:P.text.muted}},textFieldWithLabel:{"& .MuiOutlinedInput-root":{backgroundColor:"transparent",color:P.text.primary,"& fieldset":{borderColor:P.border.secondary},"&:hover fieldset":{borderColor:P.border.primary},"&.Mui-focused fieldset":{borderColor:P.accent.blue}},"& .MuiInputLabel-root":{color:P.text.muted},"& .MuiInputLabel-root.Mui-focused":{color:P.accent.blue}},select:{backgroundColor:"transparent",color:P.text.primary,"& .MuiOutlinedInput-notchedOutline":{borderColor:P.border.secondary},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:P.border.primary},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:P.accent.blue},"& .MuiSvgIcon-root":{color:P.text.muted}},panel:{backgroundColor:P.bg.secondary,border:"1px solid ".concat(P.border.primary),borderRadius:2},modal:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:P.bg.secondary,border:"1px solid ".concat(P.border.primary),borderRadius:2,p:3},buttonPrimary:{backgroundColor:"transparent",color:P.text.primary,"&:hover":{backgroundColor:"rgba(74, 158, 255, 0.1)"},"&.Mui-disabled":{backgroundColor:P.button.disabled,color:P.button.disabledText}},buttonSecondary:{py:1,backgroundColor:P.bg.tertiary,color:P.text.primary,textTransform:"none",fontWeight:500,border:"1px solid ".concat(P.border.secondary),"&:hover":{backgroundColor:P.bg.hover,borderColor:P.border.primary},"&.Mui-disabled":{backgroundColor:P.bg.secondary,color:P.border.secondary,borderColor:P.border.subtle}},iconButton:{backgroundColor:P.button.secondary,color:P.text.primary,width:24,height:24,"&:hover":{backgroundColor:P.button.secondaryHover}},iconButtonDanger:{backgroundColor:P.button.danger,color:P.text.primary,width:24,height:24,"&:hover":{backgroundColor:P.button.dangerHover}},divider:{borderColor:P.border.secondary},listItemButton:{borderRadius:1,py:.5,"&.Mui-selected":{backgroundColor:P.bg.tertiary,"&:hover":{backgroundColor:P.bg.hover}},"&:hover":{backgroundColor:P.bg.tertiary}},hoverBox:{"&:hover":{backgroundColor:P.bg.tertiary},borderRadius:1,cursor:"pointer"},iconButtonMuted:{color:P.text.muted,p:.5,"&:hover":{color:P.text.primary}},checkbox:{color:P.text.muted,"&.Mui-checked":{color:P.accent.blue}}},T={primary:{color:P.text.primary},secondary:{color:P.text.secondary},muted:{color:P.text.muted},dim:{color:P.text.dim},accent:{color:P.accent.blue},error:{color:P.accent.error}},J=e=>{let{text:t}=e,[o,s]=(0,a.useState)((null==t?void 0:t.length)>500),n=(null==t?void 0:t.length)>500,i=o?(null==t?void 0:t.slice(0,500))+"...":t;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(x.Z,{variant:"body2",sx:{color:P.text.primary,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:i}),n&&(0,r.jsx)(l.Z,{onClick:e=>{e.stopPropagation(),s(!o)},sx:{display:"flex",alignItems:"center",gap:.5,mt:.5,cursor:"pointer",color:P.accent.blue,"&:hover":{color:P.accent.blueHover}},children:o?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(w.Z,{sx:{fontSize:16}}),(0,r.jsxs)(x.Z,{variant:"caption",children:["Show more (",t.length," chars)"]})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(N.Z,{sx:{fontSize:16}}),(0,r.jsx)(x.Z,{variant:"caption",children:"Show less"})]})})]})};var _=(0,a.memo)(e=>{let{id:t,data:o,selected:n}=e,[i,d]=(0,a.useState)(!1),[u,p]=(0,a.useState)(!1),[g,m]=(0,a.useState)(""),f="loading"===o.status,b=o.isRoot,y=o.isMergeSource,v=o.isMergedNode,C=e=>{var r;e.stopPropagation(),null===(r=o.onEditNode)||void 0===r||r.call(o,t,g),p(!1)},j=e=>{e.stopPropagation(),p(!1)};return(0,r.jsxs)(l.Z,{onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),sx:{minWidth:350,maxWidth:500,backgroundColor:n?P.bg.tertiary:P.bg.secondary,border:y?"2px solid ".concat(P.accent.orange):n?"2px solid ".concat(P.accent.blue):"1px solid ".concat(P.border.primary),borderRadius:2,overflow:"hidden",cursor:"pointer",transition:"all 0.2s ease","&:hover":{borderColor:y?P.accent.orangeHover:P.text.muted}},children:[!b&&(0,r.jsx)(s.HH,{type:"target",position:s.Ly.Top,style:{background:P.accent.blue,width:8,height:8,border:"none"}}),(i||n)&&!b&&!f&&!u&&(0,r.jsxs)(l.Z,{sx:{position:"absolute",top:4,right:4,display:"flex",gap:.5,zIndex:10},children:[(0,r.jsx)(z.Z,{title:v?"Edit merge prompt":"Edit message",children:(0,r.jsx)(h.Z,{size:"small",onClick:e=>{e.stopPropagation(),m(o.userMessage||""),p(!0)},sx:H.iconButton,children:(0,r.jsx)(R.Z,{sx:{fontSize:14}})})}),v&&(0,r.jsx)(z.Z,{title:"Regenerate merge (respects edge context settings)",children:(0,r.jsx)(h.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onRegenerateMerge)||void 0===r||r.call(o,t)},sx:{backgroundColor:P.accent.orange,color:P.text.primary,width:24,height:24,"&:hover":{backgroundColor:P.accent.orangeHover}},children:(0,r.jsx)(B.Z,{sx:{fontSize:14}})})}),(0,r.jsx)(z.Z,{title:"Merge branches here",children:(0,r.jsx)(h.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onMergeNode)||void 0===r||r.call(o,t)},sx:H.iconButton,children:(0,r.jsx)(K.Z,{sx:{fontSize:14}})})}),(0,r.jsx)(z.Z,{title:"Delete node",children:(0,r.jsx)(h.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onDeleteNode)||void 0===r||r.call(o,t)},sx:H.iconButtonDanger,children:(0,r.jsx)(A.Z,{sx:{fontSize:14}})})})]}),!b&&(0,r.jsxs)(l.Z,{sx:{p:1.5,backgroundColor:P.bg.userMessage,borderBottom:"1px solid ".concat(P.border.secondary)},children:[(0,r.jsx)(x.Z,{variant:"caption",sx:{color:P.accent.userLabel,fontWeight:500,mb:.5,display:"block"},children:"You"}),u?(0,r.jsxs)(l.Z,{sx:{display:"flex",flexDirection:"column",gap:1},children:[(0,r.jsx)(c.Z,{value:g,onChange:e=>m(e.target.value),multiline:!0,minRows:2,maxRows:6,size:"small",autoFocus:!0,onClick:e=>e.stopPropagation(),onKeyDown:e=>{"Enter"===e.key&&e.metaKey?C(e):"Escape"===e.key&&j(e)},sx:{...H.textField,"& .MuiOutlinedInput-root":{...H.textField["& .MuiOutlinedInput-root"],fontSize:"0.875rem"}}}),(0,r.jsxs)(l.Z,{sx:{display:"flex",gap:.5,justifyContent:"flex-end"},children:[(0,r.jsx)(h.Z,{size:"small",onClick:j,sx:H.iconButton,children:(0,r.jsx)(W.Z,{sx:{fontSize:14}})}),(0,r.jsx)(h.Z,{size:"small",onClick:C,sx:{...H.buttonPrimary,width:24,height:24},children:(0,r.jsx)(D.Z,{sx:{fontSize:14}})})]})]}):(0,r.jsx)(J,{text:o.userMessage})]}),(0,r.jsx)(l.Z,{sx:{p:1.5,minHeight:40},children:b?(0,r.jsx)(x.Z,{variant:"body2",sx:{color:P.text.muted,fontStyle:"italic"},children:"Start a conversation..."}):f?(0,r.jsxs)(l.Z,{display:"flex",alignItems:"center",gap:1,children:[(0,r.jsx)(O.Z,{size:16,sx:{color:P.accent.blue}}),(0,r.jsx)(x.Z,{variant:"body2",sx:{color:P.text.muted},children:"Generating..."})]}):o.assistantMessage?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(x.Z,{variant:"caption",sx:{color:P.accent.green,fontWeight:500,mb:.5,display:"block"},children:"Assistant"}),(0,r.jsx)(J,{text:o.assistantMessage})]}):o.error?(0,r.jsxs)(x.Z,{variant:"body2",sx:{color:P.accent.error},children:["Error: ",o.error]}):null}),(i||n)&&!f&&(0,r.jsx)(l.Z,{sx:{position:"absolute",bottom:-20,left:"50%",transform:"translateX(-50%)",zIndex:10},children:(0,r.jsx)(h.Z,{size:"small",onClick:e=>{var r;e.stopPropagation(),null===(r=o.onAddBranch)||void 0===r||r.call(o,t)},sx:{...H.buttonPrimary,width:24,height:24},children:(0,r.jsx)(I.Z,{sx:{fontSize:16}})})}),(0,r.jsx)(s.HH,{type:"source",position:s.Ly.Bottom,style:{background:P.accent.blue,width:8,height:8,border:"none"}})]})});let G={FULL:"full",SINGLE:"single"};var Y=(0,a.memo)(e=>{let{id:t,sourceX:o,sourceY:a,targetX:n,targetY:i,sourcePosition:d,targetPosition:c,style:u={},data:p,markerEnd:g}=e,[h,x,m]=(0,s.OQ)({sourceX:o,sourceY:a,sourcePosition:d,targetX:n,targetY:i,targetPosition:c}),f=(null==p?void 0:p.contextMode)||G.FULL,b=null==p?void 0:p.isMergeEdge,y=null==p?void 0:p.onToggleContextMode;return b?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("path",{id:t,style:u,className:"react-flow__edge-path",d:h,markerEnd:g}),(0,r.jsx)(s.XQ,{children:(0,r.jsx)(z.Z,{title:f===G.FULL?"Full branch context - Click to use single message only":"Single message only - Click to use full branch context",arrow:!0,children:(0,r.jsx)(l.Z,{onClick:e=>{e.stopPropagation(),null==y||y(t)},sx:{position:"absolute",transform:"translate(-50%, -50%) translate(".concat(x,"px,").concat(m,"px)"),pointerEvents:"all",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",width:24,height:24,borderRadius:"50%",backgroundColor:f===G.FULL?P.accent.orange:P.border.primary,border:"2px solid ".concat(P.bg.primary),color:P.text.primary,fontSize:10,fontWeight:"bold",transition:"all 0.2s ease","&:hover":{transform:"translate(-50%, -50%) translate(".concat(x,"px,").concat(m,"px) scale(1.2)"),backgroundColor:f===G.FULL?P.accent.orangeHover:P.text.muted}},children:f===G.FULL?"∞":"1"})})})]}):(0,r.jsx)("path",{id:t,style:u,className:"react-flow__edge-path",d:h,markerEnd:g})});let V=["chatgpt-4o-latest","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo","o1-preview","o1-mini"],Q={chatNode:_},X={mergeEdge:Y},$=[{id:"root",type:"chatNode",position:{x:400,y:50},data:{isRoot:!0,userMessage:"",assistantMessage:"",status:"complete"}}],q=[],ee=(e,t,o)=>{let r=[],a=e;for(;a;){let e=t.find(e=>e.id===a);e&&r.unshift(e);let s=o.find(e=>e.target===a);a=s?s.source:null}return r},et=e=>{let t=[];for(let o of e)!o.data.isRoot&&(o.data.userMessage&&t.push({role:"user",content:o.data.userMessage}),o.data.assistantMessage&&t.push({role:"assistant",content:o.data.assistantMessage}));return t},eo=(e,t,o,r)=>{let a=ee(e,o,r),s=ee(t,o,r),n=new Set(a.map(e=>e.id));for(let e=s.length-1;e>=0;e--)if(n.has(s[e].id))return s[e].id;return"root"},er=(e,t,o)=>{let r=[],a=[e];for(;a.length>0;){let e=a.shift();for(let t of o.filter(t=>t.source===e))r.push(t.target),a.push(t.target)}return r},ea="bushchat-chats",es="bushchat-active-chat",en=()=>"chat-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),ei=e=>{var t;let o=e.find(e=>{var t,o;return!(null===(t=e.data)||void 0===t?void 0:t.isRoot)&&(null===(o=e.data)||void 0===o?void 0:o.userMessage)});if(null==o?void 0:null===(t=o.data)||void 0===t?void 0:t.userMessage){let e=o.data.userMessage;return e.length>30?e.substring(0,30)+"...":e}return"New Chat"},el=()=>{try{let e=localStorage.getItem(ea);if(e)return JSON.parse(e)}catch(e){console.error("Failed to load chats list:",e)}return[]},ed=e=>{try{localStorage.setItem(ea,JSON.stringify(e))}catch(e){console.error("Failed to save chats list:",e)}},ec=e=>{try{let t=localStorage.getItem("bushchat-".concat(e));if(t)return JSON.parse(t)}catch(e){console.error("Failed to load chat state:",e)}return null},eu=(e,t,o,r,a)=>{try{let s=t.map(e=>({...e,data:{...e.data,onAddBranch:void 0,onEditNode:void 0,onDeleteNode:void 0,onMergeNode:void 0,onRegenerateMerge:void 0,isMergeSource:void 0}}));localStorage.setItem("bushchat-".concat(e),JSON.stringify({nodes:s,edges:o,selectedNodeId:r,nodeIdCounter:a}));let n=el(),i=n.findIndex(t=>t.id===e);i>=0&&(n[i].name=ei(s),n[i].updatedAt=Date.now(),ed(n))}catch(e){console.error("Failed to save chat state:",e)}},ep=()=>{try{let e=localStorage.getItem(es);if(!e){e=en(),localStorage.setItem(es,e);let t=[{id:e,name:"New Chat",createdAt:Date.now(),updatedAt:Date.now()}];ed(t)}return e}catch(e){console.error("Failed to get active chat:",e)}return en()},eg=e=>{localStorage.setItem(es,e)},eh="bushchat-settings",ex="bushchat-api-key",em=()=>{try{let e=localStorage.getItem(eh),t=localStorage.getItem(ex),o=e?JSON.parse(e):{apiUrl:"",saveApiKey:!1};return t&&o.saveApiKey?o.apiKey=t:o.apiKey="",o}catch(e){console.error("Failed to load settings:",e)}return{apiKey:"",apiUrl:"",saveApiKey:!1}},ef=(e,t)=>{try{let o={apiUrl:e.apiUrl,saveApiKey:t};localStorage.setItem(eh,JSON.stringify(o)),t&&e.apiKey?localStorage.setItem(ex,e.apiKey):localStorage.removeItem(ex)}catch(e){console.error("Failed to save settings:",e)}},eb=()=>{var e;let[t,o]=(0,a.useState)(()=>ep()),[z,O]=(0,a.useState)(()=>el()),[R,A]=(0,a.useState)(!1),[D,W]=(0,a.useState)(!1),[K,B]=(0,a.useState)(()=>em()),[J,_]=(0,a.useState)({apiKey:"",apiUrl:"",saveApiKey:!1}),[Y,ea]=(0,a.useState)(!1),[es,ei]=(0,a.useState)(""),[eh,ex]=(0,a.useState)(!1),eb=(0,a.useMemo)(()=>ec(t),[t]),[ey,ev,eC]=(0,s.Rr)((null==eb?void 0:eb.nodes)||$),[ej,ek,eZ]=(0,s.ll)((null==eb?void 0:eb.edges)||q),[eS,eM]=(0,a.useState)((null==eb?void 0:eb.selectedNodeId)||"root"),[ew,eN]=(0,a.useState)(""),[eI,eL]=(0,a.useState)(V[0]),[eE,eF]=(0,a.useState)(V),[eU,ez]=(0,a.useState)(!1),[eO,eR]=(0,a.useState)(null),eA=(0,a.useRef)((null==eb?void 0:eb.nodeIdCounter)||1),{fitView:eD}=(0,s._K)();(0,a.useEffect)(()=>{let e=setTimeout(()=>{eu(t,ey,ej,eS,eA.current),O(el())},500);return()=>clearTimeout(e)},[ey,ej,eS,t]);let eW=(0,a.useCallback)(e=>{eg(e),o(e);let t=ec(e);t?(ev(t.nodes||$),ek(t.edges||q),eM(t.selectedNodeId||"root"),eA.current=t.nodeIdCounter||1):(ev($),ek(q),eM("root"),eA.current=1),eR(null),setTimeout(()=>eD({padding:.2}),100)},[ev,ek,eD]),eK=(0,a.useCallback)(()=>{let e=en(),t=[{id:e,name:"New Chat",createdAt:Date.now(),updatedAt:Date.now()},...z];ed(t),O(t),eW(e)},[z,eW]),eB=(0,a.useCallback)((e,o)=>{if(o.stopPropagation(),z.length<=1)return;let r=z.filter(t=>t.id!==e);ed(r),O(r),localStorage.removeItem("bushchat-".concat(e)),e===t&&r.length>0&&eW(r[0].id)},[z,t,eW]),eP=(0,a.useCallback)(()=>{_({...K}),W(!0)},[K]),eH=(0,a.useCallback)(()=>{B(J),ef(J,J.saveApiKey),W(!1)},[J]),eT=(0,a.useCallback)(()=>{console.log("Waitlist signup:",es),localStorage.setItem("bushchat-waitlist-email",es),ex(!0)},[es]);(0,a.useEffect)(()=>{{let e=localStorage.getItem("bushchat-waitlist-email");e&&(ei(e),ex(!0))}},[]);let eJ=(0,a.useCallback)(async(e,t)=>{ez(!0);try{var o,r,a;let s=await fetch("".concat(t||"https://api.openai.com/v1","/models"),{headers:e?{Authorization:"Bearer ".concat(e)}:{}});if(!s.ok)throw Error("Failed to fetch models");let n=await s.json(),i=(null===(a=n.data)||void 0===a?void 0:null===(r=a.map(e=>e.id))||void 0===r?void 0:null===(o=r.filter(e=>e&&!e.includes("embedding")&&!e.includes("whisper")&&!e.includes("tts")&&!e.includes("dall-e")))||void 0===o?void 0:o.sort())||[];i.length>0&&(eF(i),eL(e=>i.includes(e)?e:i[0]))}catch(e){console.error("Failed to fetch models:",e)}finally{ez(!1)}},[]),e_=(0,a.useCallback)(()=>{eJ(J.apiKey,J.apiUrl)},[J,eJ]),eG=(0,a.useRef)(!1);(0,a.useEffect)(()=>{!eG.current&&(K.apiKey||K.apiUrl)&&(eG.current=!0,eJ(K.apiKey,K.apiUrl))},[K.apiKey,K.apiUrl,eJ]);let eY=(0,a.useMemo)(()=>ey.find(e=>e.id===eS),[ey,eS]),eV=(0,a.useMemo)(()=>et(ee(eS,ey,ej)),[eS,ey,ej]),eQ=(0,a.useCallback)((e,t)=>{ev(o=>o.map(o=>o.id===e?{...o,data:{...o.data,...t}}:o))},[ev]),eX=(0,a.useCallback)(async(e,t)=>{let o="node-".concat(eA.current++),r=ey.find(t=>t.id===e),a=ej.filter(t=>t.source===e),s=320*a.length,n={id:o,type:"chatNode",position:{x:r.position.x+s-(a.length>0?160:0),y:r.position.y+200},data:{userMessage:t,assistantMessage:"",status:"loading",isRoot:!1}};ev(e=>[...e,n]),ek(t=>[...t,{id:"edge-".concat(e,"-").concat(o),source:e,target:o,type:"smoothstep",style:{stroke:"#4a9eff",strokeWidth:2}}]),eM(o);let i=et(ee(e,ey,ej));i.push({role:"user",content:t});try{let e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:i,model:eI,apiKey:K.apiKey||void 0,apiUrl:K.apiUrl||void 0})}),t=e.headers.get("content-type");if(null==t?void 0:t.includes("text/event-stream")){let t=e.body.getReader(),r=new TextDecoder,a="";for(;;){let{done:e,value:s}=await t.read();if(e)break;for(let e of r.decode(s).split("\n").filter(e=>e.startsWith("data: "))){let t=e.slice(6);if("[DONE]"!==t)try{let e=JSON.parse(t);e.content&&(a+=e.content,eQ(o,{assistantMessage:a,status:"loading"}))}catch(e){}}}eQ(o,{assistantMessage:a,status:"complete"})}else{let t=await e.json();if(!e.ok)throw Error(t.error||"Failed to get response");eQ(o,{assistantMessage:t.response,status:"complete"})}}catch(e){console.error(e),eQ(o,{error:e.message,status:"error"})}setTimeout(()=>eD({padding:.2,duration:300}),100)},[ey,ej,eI,ev,ek,eQ,eD,K]),e$=(0,a.useCallback)(e=>{var t;eM(e),null===(t=document.getElementById("message-input"))||void 0===t||t.focus()},[]),eq=(0,a.useCallback)(async(e,t)=>{var o,r,a;if(!t.trim())return;let s=ey.find(t=>t.id===e);if((null==s?void 0:null===(o=s.data)||void 0===o?void 0:o.isMergedNode)&&s.data.mergeParents){let o,n;let[i,l]=s.data.mergeParents,d=s.data.lcaId,c=ej.find(t=>t.source===i&&t.target===e),u=ej.find(t=>t.source===l&&t.target===e),p=(null==c?void 0:null===(r=c.data)||void 0===r?void 0:r.contextMode)||G.SINGLE,g=(null==u?void 0:null===(a=u.data)||void 0===a?void 0:a.contextMode)||G.SINGLE,h=ee(i,ey,ej),x=ee(l,ey,ej),m=h.findIndex(e=>e.id===d),f=x.findIndex(e=>e.id===d);if(p===G.FULL)o=h.slice(m+1);else{let e=h[h.length-1];o=e?[e]:[]}if(g===G.FULL)n=x.slice(f+1);else{let e=x[x.length-1];n=e?[e]:[]}let b=et(h.slice(0,m+1)),y=et(o),v=et(n),C=p===G.FULL?"full context":"single message",j=g===G.FULL?"full context":"single message",k="You are continuing a conversation that has branched into two paths. Here are both branches:\n\n";for(let e of(k+="=== BRANCH A (".concat(C,") ===\n"),y))k+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");for(let e of(k+="=== BRANCH B (".concat(j,") ===\n"),v))k+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");k+="=== END BRANCHES ===\n\n"+t,eQ(e,{userMessage:t,assistantMessage:"",status:"loading",error:null});let Z=[...b,{role:"user",content:k}];try{let t=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:Z,model:eI,apiKey:K.apiKey||void 0,apiUrl:K.apiUrl||void 0})}),o=t.headers.get("content-type");if(null==o?void 0:o.includes("text/event-stream")){let o=t.body.getReader(),r=new TextDecoder,a="";for(;;){let{done:t,value:s}=await o.read();if(t)break;for(let t of r.decode(s).split("\n").filter(e=>e.startsWith("data: "))){let o=t.slice(6);if("[DONE]"!==o)try{let t=JSON.parse(o);t.content&&(a+=t.content,eQ(e,{assistantMessage:a,status:"loading"}))}catch(e){}}}eQ(e,{assistantMessage:a,status:"complete"})}else{let o=await t.json();if(!t.ok)throw Error(o.error||"Failed to get response");eQ(e,{assistantMessage:o.response,status:"complete"})}}catch(t){console.error(t),eQ(e,{error:t.message,status:"error"})}return}eQ(e,{userMessage:t,assistantMessage:"",status:"loading",error:null});let n=ej.find(t=>t.target===e),i=et(ee((null==n?void 0:n.source)||"root",ey,ej));i.push({role:"user",content:t});try{let t=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:i,model:eI,apiKey:K.apiKey||void 0,apiUrl:K.apiUrl||void 0})}),o=t.headers.get("content-type");if(null==o?void 0:o.includes("text/event-stream")){let o=t.body.getReader(),r=new TextDecoder,a="";for(;;){let{done:t,value:s}=await o.read();if(t)break;for(let t of r.decode(s).split("\n").filter(e=>e.startsWith("data: "))){let o=t.slice(6);if("[DONE]"!==o)try{let t=JSON.parse(o);t.content&&(a+=t.content,eQ(e,{assistantMessage:a,status:"loading"}))}catch(e){}}}eQ(e,{assistantMessage:a,status:"complete"})}else{let o=await t.json();if(!t.ok)throw Error(o.error||"Failed to get response");eQ(e,{assistantMessage:o.response,status:"complete"})}}catch(t){console.error(t),eQ(e,{error:t.message,status:"error"})}},[ey,ej,eI,eQ,K]),e0=(0,a.useCallback)(e=>{if("root"===e)return;let t=er(e,ey,ej),o=new Set([e,...t]),r=ej.find(t=>t.target===e),a=(null==r?void 0:r.source)||"root";ev(e=>e.filter(e=>!o.has(e.id))),ek(e=>e.filter(e=>!o.has(e.source)&&!o.has(e.target))),eM(a)},[ey,ej,ev,ek]),e1=(0,a.useCallback)(e=>{ek(t=>t.map(t=>{if(t.id===e){var o;let e=((null===(o=t.data)||void 0===o?void 0:o.contextMode)||G.FULL)===G.FULL?G.SINGLE:G.FULL;return{...t,data:{...t.data,contextMode:e}}}return t}))},[ek]),e5=(0,a.useCallback)(async e=>{var t,o,r;let a,s;let n=ey.find(t=>t.id===e);if(!(null==n?void 0:null===(t=n.data)||void 0===t?void 0:t.isMergedNode)||!n.data.mergeParents)return;let[i,l]=n.data.mergeParents,d=n.data.lcaId,c=ej.find(t=>t.source===i&&t.target===e),u=ej.find(t=>t.source===l&&t.target===e),p=(null==c?void 0:null===(o=c.data)||void 0===o?void 0:o.contextMode)||G.FULL,g=(null==u?void 0:null===(r=u.data)||void 0===r?void 0:r.contextMode)||G.FULL,h=ee(i,ey,ej),x=ee(l,ey,ej),m=h.findIndex(e=>e.id===d),f=x.findIndex(e=>e.id===d);if(p===G.FULL)a=h.slice(m+1);else{let e=h[h.length-1];a=e?[e]:[]}if(g===G.FULL)s=x.slice(f+1);else{let e=x[x.length-1];s=e?[e]:[]}let b=et(h.slice(0,m+1)),y=et(a),v=et(s),C=p===G.FULL?"full context":"single message",j=g===G.FULL?"full context":"single message",k="You are continuing a conversation that has branched into two paths. Here are both branches:\n\n";for(let e of(k+="=== BRANCH A (".concat(C,") ===\n"),y))k+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");for(let e of(k+="=== BRANCH B (".concat(j,") ===\n"),v))k+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");k+="=== END BRANCHES ===\n\nPlease synthesize insights from both branches and continue the conversation, acknowledging key points from each path.",eQ(e,{assistantMessage:"",status:"loading",error:null});let Z=[...b,{role:"user",content:k}];try{let t=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:Z,model:eI,apiKey:K.apiKey||void 0,apiUrl:K.apiUrl||void 0})}),o=t.headers.get("content-type");if(null==o?void 0:o.includes("text/event-stream")){let o=t.body.getReader(),r=new TextDecoder,a="";for(;;){let{done:t,value:s}=await o.read();if(t)break;for(let t of r.decode(s).split("\n").filter(e=>e.startsWith("data: "))){let o=t.slice(6);if("[DONE]"!==o)try{let t=JSON.parse(o);t.content&&(a+=t.content,eQ(e,{assistantMessage:a,status:"loading"}))}catch(e){}}}eQ(e,{assistantMessage:a,status:"complete"})}else{let o=await t.json();if(!t.ok)throw Error(o.error||"Failed to get response");eQ(e,{assistantMessage:o.response,status:"complete"})}}catch(t){console.error(t),eQ(e,{error:t.message,status:"error"})}},[ey,ej,eI,eQ,K]),e2=(0,a.useCallback)(async e=>{if("root"===e)return;if(!eO){eR({firstNodeId:e});return}if(eO.firstNodeId===e){eR(null);return}let t=eO.firstNodeId,o=eo(t,e,ey,ej),r=ee(t,ey,ej),a=ee(e,ey,ej),s=r.findIndex(e=>e.id===o),n=a.findIndex(e=>e.id===o),i=r.slice(s+1),l=a.slice(n+1),d=et(r.slice(0,s+1)),c=et(i),u=et(l),p="You are continuing a conversation that has branched into two paths. Here are both branches:\n\n";for(let e of(p+="=== BRANCH A ===\n",c))p+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");for(let e of(p+="=== BRANCH B ===\n",u))p+="".concat(e.role.toUpperCase(),": ").concat(e.content,"\n\n");p+="=== END BRANCHES ===\n\nPlease synthesize insights from both branches and continue the conversation, acknowledging key points from each path.";let g="node-".concat(eA.current++),h=ey.find(e=>e.id===t),x=ey.find(t=>t.id===e),m={id:g,type:"chatNode",position:{x:(h.position.x+x.position.x)/2,y:Math.max(h.position.y,x.position.y)+200},data:{userMessage:"[Merged from two branches]",assistantMessage:"",status:"loading",isRoot:!1,isMergedNode:!0,mergeParents:[t,e],lcaId:o}},f="edge-".concat(t,"-").concat(g),b="edge-".concat(e,"-").concat(g);ev(e=>[...e,m]),ek(o=>[...o,{id:f,source:t,target:g,type:"mergeEdge",style:{stroke:"#ff9800",strokeWidth:2},data:{isMergeEdge:!0,contextMode:G.SINGLE}},{id:b,source:e,target:g,type:"mergeEdge",style:{stroke:"#ff9800",strokeWidth:2},data:{isMergeEdge:!0,contextMode:G.SINGLE}}]),eM(g),eR(null);let y=[...d,{role:"user",content:p}];try{let e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:y,model:eI,apiKey:K.apiKey||void 0,apiUrl:K.apiUrl||void 0})}),t=e.headers.get("content-type");if(null==t?void 0:t.includes("text/event-stream")){let t=e.body.getReader(),o=new TextDecoder,r="";for(;;){let{done:e,value:a}=await t.read();if(e)break;for(let e of o.decode(a).split("\n").filter(e=>e.startsWith("data: "))){let t=e.slice(6);if("[DONE]"!==t)try{let e=JSON.parse(t);e.content&&(r+=e.content,eQ(g,{assistantMessage:r,status:"loading"}))}catch(e){}}}eQ(g,{assistantMessage:r,status:"complete"})}else{let t=await e.json();if(!e.ok)throw Error(t.error||"Failed to get response");eQ(g,{assistantMessage:t.response,status:"complete"})}}catch(e){console.error(e),eQ(g,{error:e.message,status:"error"})}setTimeout(()=>eD({padding:.2,duration:300}),100)},[eO,ey,ej,eI,ev,ek,eQ,eD,K]),e4=(0,a.useMemo)(()=>ey.map(e=>({...e,data:{...e.data,onAddBranch:e$,onEditNode:eq,onDeleteNode:e0,onMergeNode:e2,onRegenerateMerge:e5,isMergeSource:(null==eO?void 0:eO.firstNodeId)===e.id}})),[ey,e$,eq,e0,e2,e5,eO]),e8=(0,a.useMemo)(()=>ej.map(e=>({...e,data:{...e.data,onToggleContextMode:e1}})),[ej,e1]),e6=(0,a.useCallback)((e,t)=>{eM(t.id)},[]);return(0,r.jsx)(l.Z,{sx:{width:"100vw",height:"100vh",backgroundColor:"#252627"},children:(0,r.jsxs)(s.x$,{nodes:e4,edges:e8,onNodesChange:eC,onEdgesChange:eZ,onNodeClick:e6,nodeTypes:Q,edgeTypes:X,fitView:!0,minZoom:.1,maxZoom:2,defaultViewport:{x:0,y:0,zoom:.8},proOptions:{hideAttribution:!0},deleteKeyCode:null,selectionKeyCode:null,children:[(0,r.jsx)(n.A,{color:"#888888",gap:20}),(0,r.jsx)(i.Z,{style:{backgroundColor:P.bg.secondary,borderRadius:8,border:"1px solid ".concat(P.border.primary)}}),(0,r.jsx)(s.s_,{position:"bottom-center",children:(0,r.jsxs)(d.Z,{component:"form",onSubmit:e=>{e.preventDefault(),ew.trim()&&(eX(eS,ew.trim()),eN(""))},sx:{...H.panel,display:"flex",alignItems:"center",gap:1,p:1.5,minWidth:600,mb:2},children:[(0,r.jsx)(c.Z,{id:"message-input",placeholder:(null==eY?void 0:null===(e=eY.data)||void 0===e?void 0:e.isRoot)?"Start a new conversation...":"Continue or branch from selected node...",variant:"outlined",size:"small",value:ew,onChange:e=>eN(e.target.value),fullWidth:!0,autoComplete:"off",autoCorrect:"off",spellCheck:!1,sx:H.textField}),(0,r.jsx)(u.Z,{size:"small",sx:{minWidth:160},children:(0,r.jsx)(p.Z,{value:eI,onChange:e=>eL(e.target.value),sx:H.select,children:eE.map(e=>(0,r.jsx)(g.Z,{value:e,children:e},e))})}),(0,r.jsx)(h.Z,{type:"submit",disabled:!ew.trim(),sx:H.buttonPrimary,children:(0,r.jsx)(M.Z,{})})]})}),(0,r.jsx)(s.s_,{position:"top-left",children:(0,r.jsxs)(d.Z,{sx:{...H.panel,border:eO?"1px solid ".concat(P.accent.orange):"1px solid ".concat(P.border.primary),minWidth:220,maxWidth:280,overflow:"hidden"},children:[(0,r.jsxs)(l.Z,{sx:{p:1.5,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,r.jsx)(x.Z,{variant:"subtitle2",sx:{color:P.accent.blue},children:"bushchat"}),(0,r.jsxs)(l.Z,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(0,r.jsx)(h.Z,{size:"small",onClick:()=>ea(!0),sx:H.iconButtonMuted,title:"Sync to Cloud (Coming Soon)",children:(0,r.jsx)(U.Z,{fontSize:"small"})}),(0,r.jsx)(h.Z,{size:"small",onClick:eP,sx:H.iconButtonMuted,children:(0,r.jsx)(E.Z,{fontSize:"small"})})]})]}),(0,r.jsx)(m.Z,{sx:H.divider}),(0,r.jsxs)(l.Z,{sx:{p:1},children:[(0,r.jsxs)(l.Z,{onClick:()=>A(!R),sx:{...H.hoverBox,display:"flex",alignItems:"center",justifyContent:"space-between",py:.5,px:.5,mx:-.5},children:[(0,r.jsx)(x.Z,{variant:"caption",sx:T.muted,children:"Chats"}),(0,r.jsxs)(l.Z,{sx:{display:"flex",alignItems:"center",gap:.5},children:[(0,r.jsx)(h.Z,{size:"small",onClick:e=>{e.stopPropagation(),eK()},sx:{color:P.accent.blue,p:.25},children:(0,r.jsx)(I.Z,{sx:{fontSize:16}})}),R?(0,r.jsx)(N.Z,{sx:{fontSize:16,color:P.text.muted}}):(0,r.jsx)(w.Z,{sx:{fontSize:16,color:P.text.muted}})]})]}),(0,r.jsx)(f.Z,{in:R,children:(0,r.jsx)(b.Z,{dense:!0,sx:{py:.5,maxHeight:200,overflow:"auto"},children:z.map(e=>(0,r.jsx)(y.ZP,{disablePadding:!0,secondaryAction:z.length>1&&(0,r.jsx)(h.Z,{edge:"end",size:"small",onClick:t=>eB(e.id,t),sx:{color:P.text.dim,"&:hover":{color:P.accent.delete},p:.5},children:(0,r.jsx)(L.Z,{fontSize:"small"})}),children:(0,r.jsx)(v.Z,{selected:e.id===t,onClick:()=>eW(e.id),sx:H.listItemButton,children:(0,r.jsx)(C.Z,{primary:e.name,primaryTypographyProps:{variant:"caption",sx:{color:e.id===t?P.text.primary:P.text.secondary,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}})})},e.id))})})]}),(0,r.jsx)(m.Z,{sx:H.divider}),(0,r.jsxs)(l.Z,{sx:{p:1.5},children:[eO?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(x.Z,{variant:"caption",sx:{color:P.accent.orange,display:"block",fontWeight:500},children:"\uD83D\uDD00 Merge Mode Active"}),(0,r.jsx)(x.Z,{variant:"caption",sx:{...T.muted,display:"block",mt:.5},children:"Click another node to merge, or click the same node to cancel"}),(0,r.jsx)(j.Z,{size:"small",onClick:()=>eR(null),sx:{mt:1,color:P.accent.orange,borderColor:P.accent.orange,"&:hover":{borderColor:P.accent.orangeHover,backgroundColor:"rgba(255,152,0,0.1)"}},variant:"outlined",children:"Cancel Merge"})]}):(0,r.jsx)(x.Z,{variant:"caption",sx:{...T.muted,display:"block"},children:"(+) branch • Edit/Delete on hover • Merge icon to combine"}),eV.length>0&&(0,r.jsxs)(x.Z,{variant:"caption",sx:{...T.dim,display:"block",mt:.5},children:["Context: ",eV.length," messages"]})]})]})}),(0,r.jsx)(k.Z,{open:D,onClose:()=>W(!1),children:(0,r.jsxs)(d.Z,{sx:{...H.modal,minWidth:400,maxWidth:500},children:[(0,r.jsx)(x.Z,{variant:"h6",sx:{color:P.text.primary,mb:2},children:"Settings"}),(0,r.jsxs)(l.Z,{sx:{display:"flex",flexDirection:"column",gap:2},children:[(0,r.jsx)(c.Z,{label:"API Key",type:"password",value:J.apiKey,onChange:e=>_({...J,apiKey:e.target.value}),placeholder:"sk-... (leave empty to use server .env)",fullWidth:!0,size:"small",autoComplete:"off",autoCorrect:"off",spellCheck:!1,sx:H.textFieldWithLabel}),(0,r.jsx)(Z.Z,{control:(0,r.jsx)(S.Z,{checked:J.saveApiKey,onChange:e=>_({...J,saveApiKey:e.target.checked}),sx:H.checkbox}),label:(0,r.jsx)(x.Z,{variant:"body2",sx:T.secondary,children:"\uD83D\uDE48 Save API key in browser storage"})}),(0,r.jsxs)(l.Z,{sx:{display:"flex",gap:1,alignItems:"flex-start"},children:[(0,r.jsx)(c.Z,{label:"OpenAI Compatible URL",value:J.apiUrl,onChange:e=>_({...J,apiUrl:e.target.value}),placeholder:"https://api.openai.com/v1 (leave empty for default)",fullWidth:!0,size:"small",autoComplete:"off",autoCorrect:"off",spellCheck:!1,sx:H.textFieldWithLabel}),(0,r.jsx)(h.Z,{onClick:e_,disabled:eU,sx:{mt:.5,color:P.accent.blue,"&:hover":{backgroundColor:"rgba(74, 158, 255, 0.1)"},"&.Mui-disabled":{color:P.text.dim},animation:eU?"spin 1s linear infinite":"none","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}},title:"Fetch models from API",children:(0,r.jsx)(F.Z,{})})]}),eE.length>0&&eE!==V&&(0,r.jsxs)(x.Z,{variant:"caption",sx:T.accent,children:["✓ Loaded ",eE.length," models from provider"]}),(0,r.jsx)(x.Z,{variant:"caption",sx:T.dim,children:"These settings override the server .env configuration. Leave empty to use server defaults."}),(0,r.jsxs)(l.Z,{sx:{display:"flex",gap:1,justifyContent:"flex-end",mt:1},children:[(0,r.jsx)(j.Z,{onClick:()=>W(!1),sx:T.muted,children:"Cancel"}),(0,r.jsx)(j.Z,{onClick:eH,variant:"contained",sx:H.buttonPrimary,children:"Save"})]})]})]})}),(0,r.jsx)(k.Z,{open:Y,onClose:()=>ea(!1),children:(0,r.jsx)(d.Z,{sx:{...H.modal,minWidth:360,maxWidth:420},children:(0,r.jsxs)(l.Z,{sx:{textAlign:"center"},children:[(0,r.jsx)(l.Z,{sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"12px",backgroundColor:P.bg.tertiary,border:"1px solid ".concat(P.border.secondary),mb:2},children:(0,r.jsx)(U.Z,{sx:{color:P.text.muted,fontSize:24}})}),(0,r.jsx)(x.Z,{variant:"h6",sx:{background:"linear-gradient(135deg, ".concat(P.accent.blue," 0%, #82c4ff 100%)"),backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",mb:1,fontWeight:600},children:"Cloud Sync"}),(0,r.jsx)(x.Z,{variant:"body2",sx:{...T.muted,mb:3,lineHeight:1.6},children:"Sync your conversations across devices, share branches with collaborators, and never lose your chat history."}),eh?(0,r.jsxs)(l.Z,{sx:{p:2,borderRadius:1.5,backgroundColor:"rgba(74, 158, 255, 0.08)",border:"1px solid rgba(74, 158, 255, 0.2)"},children:[(0,r.jsx)(x.Z,{variant:"body2",sx:T.accent,children:"✓ You're on the list!"}),(0,r.jsx)(x.Z,{variant:"caption",sx:{...T.dim,display:"block",mt:.5},children:"We'll notify you when cloud sync is ready."})]}):(0,r.jsxs)(l.Z,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[(0,r.jsx)(c.Z,{placeholder:"Enter your email",value:es,onChange:e=>ei(e.target.value),fullWidth:!0,size:"small",autoComplete:"email",type:"email",sx:H.textField}),(0,r.jsx)(j.Z,{onClick:eT,disabled:!es.trim()||!es.includes("@"),fullWidth:!0,sx:H.buttonSecondary,children:"Join Waitlist"})]}),(0,r.jsx)(x.Z,{variant:"caption",sx:{...T.dim,display:"block",mt:2},children:"Coming Soon"})]})})})]})})};var ey=()=>(0,r.jsx)(s.tV,{children:(0,r.jsx)(eb,{})})}}]);